name: iotafy

services:
  platform:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8084:80"
    # Ορίζουμε ΧΕΙΡΟΚΙΝΗΤΑ ένα σταθερό IOTAFY_APP_KEY.
    # ΑΛΛΑΞΕ την τιμή ΜΙΑ ΦΟΡΑ σε δικό σου δυνατό κλειδί
    # και μετά ΜΗΝ την ξαναλλάξεις, αλλιώς θα χαλάνε τα παλιά 2FA secrets.
    env_file: ".env"
    volumes:
      - data:/var/www/html/data
      - logs:/var/www/html/logs
      - firmware:/var/www/html/firmware
    restart: unless-stopped

  monitor:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - platform
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file: ".env"
    environment:
      - CONTAINER_TYPE=monitor
    volumes:
      - data:/var/www/html/data
      - logs:/var/www/html/logs
      - firmware:/var/www/html/firmware
    entrypoint: []
    # Το entrypoint.sh θα τρέξει πρώτα για να διαμορφώσει msmtp (μόνο στο monitor)
    # και μετά θα τρέξει το monitoring loop
    # Το entrypoint.sh έχει exec "$@" στο τέλος, οπότε θα εκτελέσει το command
    # Καλούμε ρητά το entrypoint.sh μέσα στο command αφού έχουμε entrypoint: []
    command: /usr/local/bin/docker-entrypoint.sh sh -c 'while true; do php /var/www/html/monitor_devices.php; sleep 60; done'
    restart: unless-stopped

volumes:
  data:
  logs:
  firmware:
