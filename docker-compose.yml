name: iotafy

services:
  platform:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8084:80"
    # Ορίζουμε ΧΕΙΡΟΚΙΝΗΤΑ ένα σταθερό IOTAFY_APP_KEY.
    # ΑΛΛΑΞΕ την τιμή ΜΙΑ ΦΟΡΑ σε δικό σου δυνατό κλειδί
    # και μετά ΜΗΝ την ξαναλλάξεις, αλλιώς θα χαλάνε τα παλιά 2FA secrets.
    env_file: ".env"
    volumes:
      - iotafy_data:/var/www/html/data:rw
      - iotafy_logs:/var/www/html/logs:rw
      - iotafy_firmware:/var/www/html/firmware:rw
    restart: unless-stopped

  monitor:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - iotafy_platform
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file: ".env"
    environment:
      - CONTAINER_TYPE=monitor
    volumes:
      - iotafy_data:/var/www/html/data:ro
      - iotafy_logs:/var/www/html/logs:rw
      - iotafy_firmware:/var/www/html/firmware:ro
    # Τρέχει το monitor_devices.php κάθε 60 δευτερόλεπτα χωρίς cron στο host
    # Το entrypoint.sh θα τρέξει πρώτα για να διαμορφώσει msmtp (μόνο στο monitor)
    command: sh -c 'while true; do php /var/www/html/monitor_devices.php; sleep 60; done'
    restart: unless-stopped

volumes:
  iotafy_data:
  iotafy_logs:
  iotafy_firmware:
